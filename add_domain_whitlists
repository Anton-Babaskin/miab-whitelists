#!/bin/bash

set -e  # Exit on any error

TARGET="$1"
if [[ -z "$TARGET" ]]; then
  echo "❌ Usage: add_to_whitelist.sh <domain-or-IP>"
  exit 1
fi

POSTFIX_FILE="/etc/postfix/client_whitelist"
POSTGREY_FILE="/etc/postgrey/whitelist_clients.local"

# --- Create backups ---
cp "$POSTFIX_FILE" "${POSTFIX_FILE}.bak_$(date +%F_%T)"
cp "$POSTGREY_FILE" "${POSTGREY_FILE}.bak_$(date +%F_%T)"

# --- Rotate old backups (older than 30 days) ---
find /etc/postfix -name "client_whitelist.bak_*" -mtime +30 -delete

# --- Add to Postfix whitelist ---
if ! grep -qE "^${TARGET//./\\.}($|[[:space:]])" "$POSTFIX_FILE"; then
  echo "$TARGET OK" >> "$POSTFIX_FILE"
  echo "✅ Added to Postfix whitelist"
else
  echo "ℹ️ $TARGET already in Postfix whitelist"
fi

# --- Add to Postgrey whitelist ---
if ! grep -qE "^${TARGET//./\\.}($|[[:space:]])" "$POSTGREY_FILE"; then
  echo "$TARGET" >> "$POSTGREY_FILE"
  echo "✅ Added to Postgrey whitelist"
else
  echo "ℹ️ $TARGET already in Postgrey whitelist"
fi

# --- Apply changes ---
postmap "$POSTFIX_FILE"
systemctl restart postfix
systemctl restart postgrey

echo "🎉 Done!"
